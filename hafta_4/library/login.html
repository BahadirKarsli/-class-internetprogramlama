<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giriş | The Library</title>
    <link rel="stylesheet" href="genel.css">
    <style>
    .login-grid{display:grid;grid-template-columns:1fr;gap:16px;align-items:stretch}
    @media(min-width: 800px){.login-grid{grid-template-columns:1fr 1fr}}
    .login-grid > .login-card{height:100%;display:flex;flex-direction:column}
    .login-grid form{flex:1;display:flex;flex-direction:column}
    .login-grid form .login-options{margin-top:auto}
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <header class="navbar">
        <div class="logo">
            <a href="index.html">
                <img src="logo.png" alt="MSB Library Logo">
            </a>
            <h1>The Library</h1>
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">Ana Sayfa</a></li>
                <li><a href="hakkimizda.html">Hakkımızda</a></li>
                <li><a href="misyon-vizyon.html">Misyon & Vizyon</a></li>
                <li><a href="iletisim.html">İletişim</a></li>
                <li><a href="login.html" class="active">Giriş</a></li>
            </ul>
        </nav>
    </header>

    <!-- MAIN LOGIN SECTION -->
    <main class="login-container">
        <div class="login-grid">
        <div class="login-card">
            <h2>🔐 Giriş Yap</h2>
            <form id="loginForm" action="admin.html" method="post">
                <label for="username">Kullanıcı Adı</label>
                <input type="text" id="username" name="username" placeholder="Kullanıcı adınızı giriniz" required>

                <label for="password">Şifre</label>
                <input type="password" id="password" name="password" placeholder="Şifrenizi giriniz" required>

                <div class="login-options">
                    <label><input type="checkbox" name="remember"> Beni hatırla</label>
                    <a href="#">Şifremi unuttum?</a>
                </div>

                <button type="submit" class="login-btn">Giriş Yap</button>
            </form>

            <div class="login-options" style="justify-content:center; margin-top: 10px;">
                <a href="#" id="openCreateAdmin">Yönetici oluştur</a>   
            </div>
        </div>

        <div class="login-card">
            <h2>🆕 Kayıt Ol</h2>
            <form id="registerForm">
                <label for="regUsername">Kullanıcı Adı</label>
                <input type="text" id="regUsername" placeholder="Kullanıcı adınız" required>

                <label for="regPassword">Şifre</label>
                <input type="password" id="regPassword" placeholder="Şifreniz" required>

                <label for="regPassword2">Şifre (Tekrar)</label>
                <input type="password" id="regPassword2" placeholder="Şifre tekrarı" required>

                <button type="submit" class="login-btn">Kayıt Ol</button>
            </form>
        </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <p>© 2025 The Library | Medeniyet Üniversitesi</p>
    </footer>
    
    <!-- Modal: Create Admin -->
    <div id="createAdminModal" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="createAdminTitle">
            <div class="modal-header">
                <h3 id="createAdminTitle">Yönetici Oluştur</h3>
                <button class="modal-close" id="closeCreateAdmin" aria-label="Kapat">×</button>
            </div>
            <form id="createAdminForm">
                <label for="adminUser">Kullanıcı Adı</label>
                <input type="text" id="adminUser" placeholder="admin" required>

                <label for="adminPass">Şifre</label>
                <input type="password" id="adminPass" placeholder="Güçlü bir şifre" required>

                <label for="adminPass2">Şifre (Tekrar)</label>
                <input type="password" id="adminPass2" placeholder="Şifre tekrarı" required>

                <button type="submit" class="btn" style="margin-top:10px; width:100%">Yöneticiyi Kaydet</button>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
    <script>
    (function(){
        const DB_KEY = 'msb_sqlite_v1';
        const SS_SESSION = 'msb_session_v2';

        const $ = (s) => document.querySelector(s);

        let SQL = null;
        let db = null;

        function saveDb(){
            const data = db.export();
            const b64 = btoa(String.fromCharCode.apply(null, data));
            localStorage.setItem(DB_KEY, b64);
        }
        function loadDb(){
            const b64 = localStorage.getItem(DB_KEY);
            if (b64){
                const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                db = new SQL.Database(bytes);
            } else {
                db = new SQL.Database();
            }
            // Tüm tabloları oluştur
            db.run(`
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    password TEXT NOT NULL
                );
                CREATE TABLE IF NOT EXISTS admins (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    password TEXT NOT NULL
                );
                CREATE TABLE IF NOT EXISTS library_books (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    title TEXT NOT NULL,
                    author TEXT NOT NULL,
                    year TEXT,
                    category TEXT,
                    created_at INTEGER
                );
                CREATE TABLE IF NOT EXISTS user_books (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    library_book_id INTEGER NOT NULL,
                    added_at INTEGER
                );
                CREATE TABLE IF NOT EXISTS announcements (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    title TEXT NOT NULL,
                    content TEXT NOT NULL,
                    created_at INTEGER
                );
            `);
            saveDb();
        }

        function setSession(username, role, remember){
            const payload = JSON.stringify({ username, role, issuedAt: Date.now() });
            if (remember) localStorage.setItem(SS_SESSION, payload);
            else sessionStorage.setItem(SS_SESSION, payload);
        }

        function openModal(){
            const o = $('#createAdminModal');
            if (!o) return;
            o.classList.add('open');
            o.setAttribute('aria-hidden','false');
            document.body.classList.add('no-scroll');
        }
        function closeModal(){
            const o = $('#createAdminModal');
            if (!o) return;
            o.classList.remove('open');
            o.setAttribute('aria-hidden','true');
            document.body.classList.remove('no-scroll');
        }

        function bindHandlers(){
            // Toggle link for admin modal
            const openLink = $('#openCreateAdmin');
            const closeBtn = $('#closeCreateAdmin');
            const overlay = $('#createAdminModal');
            if (openLink){ openLink.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); }); }
            if (closeBtn){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); }); }
            if (overlay){ overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); }); }

            // Login handler
            const loginForm = $('#loginForm');
            if (loginForm){
                loginForm.addEventListener('submit', (e)=>{
                    e.preventDefault();
                    const uname = ($('#username').value || '').trim();
                    const pass = ($('#password').value || '');
                    const remember = loginForm.querySelector('input[name="remember"]').checked;

                    // Try admin first
                    let stmt = db.prepare('SELECT id FROM admins WHERE username = ? AND password = ? LIMIT 1');
                    stmt.bind([uname, pass]);
                    const isAdmin = stmt.step();
                    stmt.free();
                    if (isAdmin){
                        setSession(uname, 'admin', remember);
                        window.location.href = 'admin.html';
                        return;
                    }

                    // Try normal user
                    stmt = db.prepare('SELECT id FROM users WHERE username = ? AND password = ? LIMIT 1');
                    stmt.bind([uname, pass]);
                    const isUser = stmt.step();
                    stmt.free();
                    if (isUser){
                        setSession(uname, 'user', remember);
                        window.location.href = 'kullanici.html';
                        return;
                    }

                    alert('Kullanıcı adı veya şifre hatalı.');
                });
            }

            // Register handler
            const registerForm = $('#registerForm');
            if (registerForm){
                registerForm.addEventListener('submit', (e)=>{
                    e.preventDefault();
                    const uname = ($('#regUsername').value || '').trim();
                    const p1 = $('#regPassword').value || '';
                    const p2 = $('#regPassword2').value || '';
                    if (!uname || !p1){ alert('Kullanıcı adı ve şifre gerekli.'); return; }
                    if (p1 !== p2){ alert('Şifreler eşleşmiyor.'); return; }
                    try {
                        const stmt = db.prepare('INSERT INTO users (username, password) VALUES (?, ?)');
                        stmt.run([uname, p1]);
                        stmt.free();
                        saveDb();
                        alert('Kayıt başarılı. Artık giriş yapabilirsiniz.');
                        registerForm.reset();
                    } catch(err){
                        const msg = String(err||'');
                        if (msg.includes('UNIQUE')) alert('Bu kullanıcı adı zaten kayıtlı.');
                        else alert('Kayıt sırasında hata oluştu: ' + msg);
                    }
                });
            }

            // Create admin handler
            const createForm = $('#createAdminForm');
            if (createForm){
                createForm.addEventListener('submit', (e)=>{
                    e.preventDefault();
                    const uname = ($('#adminUser').value || '').trim();
                    const p1 = $('#adminPass').value || '';
                    const p2 = $('#adminPass2').value || '';
                    if (!uname || !p1){ alert('Kullanıcı adı ve şifre gerekli.'); return; }
                    if (p1 !== p2){ alert('Şifreler eşleşmiyor.'); return; }
                    try {
                        const stmt = db.prepare('INSERT INTO admins (username, password) VALUES (?, ?)');
                        stmt.run([uname, p1]);
                        stmt.free();
                        saveDb();
                        alert('Yönetici oluşturuldu.');
                        closeModal();
                        createForm.reset();
                    } catch(err){
                        const msg = String(err||'');
                        if (msg.includes('UNIQUE')) alert('Bu yönetici kullanıcı adı zaten mevcut.');
                        else alert('Kayıt sırasında hata oluştu: ' + msg);
                    }
                });
            }
        }

        // Initialize sql.js and database, then bind handlers
        window.initSqlJs({ locateFile: (file) => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file })
            .then((SQLLib)=>{
                SQL = SQLLib;
                loadDb();
                bindHandlers();
            })
            .catch((err)=>{
                console.error('sql.js yüklenemedi', err);
                alert('Veritabanı başlatılamadı. İnternet bağlantınızı kontrol edin.');
            });
    })();
    </script>
</body>
</html>
